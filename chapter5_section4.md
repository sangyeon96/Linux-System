# Section 4. 패킷 필터링

리눅스 커널에는 IP 패킷 필터링 프레임워크 'Netfilter'와 이를 이용하기 위한 커맨드라인 프론트엔트 `iptables`/`ip6tables`가 준비되어 있다.

IP 패킷 필터링은 IP 패킷의 헤더를 참조하여 통과/파기/전송 등의 처리를 하는 것을 말한다. `iptables`를 이용하여 아래와 같은 네트워크 환경을 구축할 수 있다.

* 파일 필터링으로 한 대의 호스트를 요새화
* 인터넷과 LAN을 연결하나 인터넷에서 LAN 호스트를 감춤
* LAN 호스트에서 인터넷으로의 접속성을 확보하고 출발지 주소를 변환
* LAN의 특정 호스트에 패킷을 전송
* 한정적 기능이기는 하나 로드밸런싱, 부하 분산

### 4.1 리눅스에서 iptables/Netfilter를 동작

CentOS에서는 다음과 같은 명령어로 iptables 패키지 설치 여부를 알 수 있다.\(설치되어있음\)

![](/assets/iptables.png)

iptables를 이용하려면 리눅스 커널이 Netfilter 프레임워크를 이용할 수 있도록 설정되어 있어야 한다.

확인해보니 Netfilter 옵션이 유효하게 설정되어 있다.

### 4.2 TCP/IP, ICMP, 패킷 필터

`iptables`는 패킷 헤더를 보고 필터링을 실시한다. 출발지, 목적지, TCP/UDP/ICMP 프로토콜, 80/http나 25/smtp 등의 목적지 포트와 출발지 포트 등 패킷 헤더에 포함된 정보를 바탕으로 필터링을 실시한다.

`iptables`는 '상태 추적형 방화벽\(stateful firewall\)'을 구축할 수 있다. LAN에서의 인터넷 접근을 허가하고 인터넷에서 LAN에 배치된 단말기를 보호하는 방화벽을 구축하는 경우 **LAN에서 인터넷으로 나가는 패킷을 통과**시키는 것은 물론, 이에 대한 **LAN 단말기로 들어오는 응답 패킷 통과**도 허가해야만 한다. `iptables`는 이를 '**연결 추적**'이라는 기능으로 지원한다. TCP는 접속 확립\(Establisted\)을 위해 실행되는 '3way handshake' 작업의 패킷 상태를 바탕으로 패킷이 '접속 상태'에 있는지 판단한다. 이를 **stateful filtering\(stateful inspection\)**이라고 한다.

### 4.3 iptables 작성법

#### 규칙=매칭+타깃

규칙 작성은 패킷 헤더의 추출\(매칭\)과 해당 패킷의 처리\(타킷\)를 정의하는 것을 말한다. 규칙 포맷은 다음과 같다.

```
iptables -A <체인> <매칭 옵션> -j <타깃>
```

예시는 다음과 같다.

![](/assets/iptables example.png)

`-A`로 INPUT 체인에 규칙을 추가한다. `-p`로 TCP 프로토콜을 지정, `-d`로 도착지 IP주소, `--dport`로 도착지 포트, `-s`로 출발지 IP주소를 지정한다. `-j`로 타깃에 ACCEPT를 지정하여 매치된 패킷을 통과시킨다. 출발지 IP주소인 192.168.2.0/24의 네트워크 주소에 속하는 호스트로부터 도착지 IP주소인 192.168.2.1 주소를 가진 호스트의 22/TCP로의 접근을 지정하고 있다.

`iptables`의 주요 옵션은 다음과 같다.

* `-t <테이블>` : 이용할 테이블을 지정한다. 기본은 filter.
* `-A <체인>` : 지정하는 체인에 규칙을 추가한다.
* `-m <모듈>` : 매칭 모듈을 지정한다. 이 옵션 다음에 모듈별 옵션을 추가할 수 있다.\(확장 매칭 모듈의 예 : addtype, conntrack, connlimit, iprange, mac, multiport, state\)
* `-p <프로토콜>` : tcp/udp/icmp/all 중 하나를 지정한다. 기본은 all.
* `-d <도착지 주소>` : 도착지 주소 지정
* `-s <출발지 주소>` : 출발지 주소 지정
* `--dport <포트>` : 도착지 포트 지정. `-p tcp` 또는 `-p udp`와 함께 사용한다.
* `--sport <포트>` : 출발지 포트 지정. `-p tcp` 또는 `-p udp`와 함께 사용한다.
* `-i <인터페이스>` : 패킷이 들어오는 네트워크 인터페이스를 지정한다.
* `-o <인터페이스>` : 패킷이 나가는 네트워크 인터페이스를 지정한다.
* `-j <타깃>` : ACCEPT나 DROP 등의 타깃을 지정한다.

주요 옵션 중 세번째인 `-m`의 확장 매칭 모듈 중에서도 연결 추적을 시행하는 `state` 모듈의 이용 방법은 특별히 잘 알아두라고 한다.

`state` 모듈은 `iptables`의 `--state`를 이용하여 다음과 같이 기술한다.

![](/assets/iptables module example.png)

`--state`에 대한 인수는 탐지할 패킷의 상태를 지정한다. 이것은 eth0에서 eth1로 전송하는 패킷에서 ESTABLISHED\(접속 상태\) 또는 RELATED\(접속 상태에 있는 패킷의 관련 패킷\)을 ACCEPT하는 규칙이다. 복수의 상태를 지정할 때는 위의 예시와 같이 반점\(,\)을 넣어 구분한다.

다음은 `--state`로 지정 가능한 옵션이다.

* NEW : 처음 보는 패킷
* ESTABLISHED : 접속 요구\(SYN\) 후 응답\(SYN/ACK\)이 있었던 또는 응답\(SYN/ACK\) 후에 \(ACK\)가 와서 접속 상태가 되는 패킷
* RELATED : 접속 상태인 패킷과 관련된 패킷. FTP의 데이터 포트\(20/tcp\)는 이것을 이용한다.
* INVALID : NEW, ESTABLISHED, RELATED 이외의 패킷. 대부분이 DROP해도 되는 패킷이다.

다음은 타깃으로 매치된 패킷을 처리한다. 타깃으로 이용할 수 있는 파라미터는 다음과 같다.

* ACCEPT : 패킷 통과
* DROP : 패킷 버림
* QUEUE : 사용자 공간으로 패킷을 들여보냄
* RETURN : 체인 종료

### 4.4 logging

### 4.5 패킷 필터 스크립트 작성

### 4.6 디버그 방법

### 4.7 iptables 규칙 부팅 스크립트



